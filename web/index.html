<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wesee Blockchain Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .balance-display {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
        }

        .balance-display h3 {
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .balance-amount {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .wallet-input {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .leaderboard {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .leaderboard h2 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .leaderboard-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .leaderboard-table tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ Wesee Blockchain Game</h1>
            <p>Play, Stake, and Win with GT Tokens</p>
        </div>

        <!-- Wallet Connection -->
        <div class="wallet-input">
            <div class="form-group">
                <label for="walletAddress">Wallet Address:</label>
                <input type="text" id="walletAddress" placeholder="Enter your wallet address (0x...)" />
            </div>
            <button class="btn" onclick="checkBalance()">Check Balance</button>
        </div>

        <!-- Balance Display -->
        <div class="balance-display" id="balanceDisplay" style="display: none;">
            <h3>üéØ Your GT Balance</h3>
            <div class="balance-amount" id="balanceAmount">0 GT</div>
            <p>Connected: <span id="connectedAddress"></span></p>
        </div>

        <div class="main-content">
            <!-- Buy GT with USDT -->
            <div class="card">
                <h2>üí∞ Buy GT Tokens</h2>
                <div class="form-group">
                    <label for="usdtAmount">USDT Amount:</label>
                    <input type="number" id="usdtAmount" placeholder="Enter USDT amount" min="1" step="1" />
                </div>
                <button class="btn" onclick="buyGT()">Buy GT Tokens</button>
                <div id="purchaseStatus"></div>
            </div>

            <!-- Create/Stake Match -->
            <div class="card">
                <h2>üéØ Create Match</h2>
                <div class="form-group">
                    <label for="matchId">Match ID:</label>
                    <input type="text" id="matchId" placeholder="Enter unique match ID" />
                </div>
                <div class="form-group">
                    <label for="player1">Player 1 Address:</label>
                    <input type="text" id="player1" placeholder="0x..." />
                </div>
                <div class="form-group">
                    <label for="player2">Player 2 Address:</label>
                    <input type="text" id="player2" placeholder="0x..." />
                </div>
                <div class="form-group">
                    <label for="stakeAmount">Stake Amount (GT):</label>
                    <input type="number" id="stakeAmount" placeholder="Enter stake amount" min="1" step="1" />
                </div>
                <button class="btn" onclick="createMatch()">Create Match</button>
                <div id="createMatchStatus"></div>
            </div>

            <!-- Submit Result -->
            <div class="card">
                <h2>üèÜ Submit Result</h2>
                <div class="form-group">
                    <label for="resultMatchId">Match ID:</label>
                    <input type="text" id="resultMatchId" placeholder="Enter match ID" />
                </div>
                <div class="form-group">
                    <label for="winnerAddress">Winner Address:</label>
                    <input type="text" id="winnerAddress" placeholder="0x..." />
                </div>
                <button class="btn" onclick="submitResult()">Submit Result</button>
                <div id="submitResultStatus"></div>
            </div>

            <!-- Match Info -->
            <div class="card">
                <h2>üìä Match Information</h2>
                <div class="form-group">
                    <label for="infoMatchId">Match ID:</label>
                    <input type="text" id="infoMatchId" placeholder="Enter match ID" />
                </div>
                <button class="btn" onclick="getMatchInfo()">Get Match Info</button>
                <div id="matchInfoStatus"></div>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="leaderboard">
            <h2>üèÖ Leaderboard</h2>
            <button class="btn" onclick="refreshLeaderboard()" style="margin-bottom: 20px;">Refresh Leaderboard</button>
            <div id="leaderboardContent">
                <div class="loading">Click "Refresh Leaderboard" to load data</div>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_BASE = 'http://localhost:3001';
        const LEADERBOARD_BASE = 'http://localhost:3002';

        // Utility functions
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function clearStatus(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = '';
        }

        function validateAddress(address) {
            return /^0x[a-fA-F0-9]{40}$/.test(address);
        }

        // Check GT Balance
        async function checkBalance() {
            const address = document.getElementById('walletAddress').value.trim();
            
            if (!validateAddress(address)) {
                showStatus('balanceDisplay', 'Please enter a valid wallet address', 'error');
                return;
            }

            try {
                const response = await fetch(`${BACKEND_BASE}/balance/${address}`);
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('balanceAmount').textContent = `${data.balance} GT`;
                    document.getElementById('connectedAddress').textContent = address;
                    document.getElementById('balanceDisplay').style.display = 'block';
                    showStatus('balanceDisplay', 'Balance loaded successfully!', 'success');
                } else {
                    showStatus('balanceDisplay', `Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus('balanceDisplay', `Network error: ${error.message}`, 'error');
            }
        }

        // Buy GT Tokens
        async function buyGT() {
            const amount = document.getElementById('usdtAmount').value;
            
            if (!amount || amount <= 0) {
                showStatus('purchaseStatus', 'Please enter a valid USDT amount', 'error');
                return;
            }

            clearStatus('purchaseStatus');
            showStatus('purchaseStatus', 'Processing purchase...', 'info');

            try {
                const response = await fetch(`${BACKEND_BASE}/purchase?amount=${amount}`);
                const data = await response.json();

                if (response.ok) {
                    showStatus('purchaseStatus', 
                        `Success! Would mint ${data.gtOut} GT for ${data.usdtAmount} USDT`, 
                        'success'
                    );
                } else {
                    showStatus('purchaseStatus', `Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus('purchaseStatus', `Network error: ${error.message}`, 'error');
            }
        }

        // Create Match
        async function createMatch() {
            const matchId = document.getElementById('matchId').value.trim();
            const p1 = document.getElementById('player1').value.trim();
            const p2 = document.getElementById('player2').value.trim();
            const stake = document.getElementById('stakeAmount').value;

            if (!matchId || !p1 || !p2 || !stake) {
                showStatus('createMatchStatus', 'Please fill in all fields', 'error');
                return;
            }

            if (!validateAddress(p1) || !validateAddress(p2)) {
                showStatus('createMatchStatus', 'Please enter valid addresses', 'error');
                return;
            }

            if (p1 === p2) {
                showStatus('createMatchStatus', 'Player 1 and Player 2 must be different', 'error');
                return;
            }

            clearStatus('createMatchStatus');
            showStatus('createMatchStatus', 'Creating match...', 'info');

            try {
                const response = await fetch(`${BACKEND_BASE}/match/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ matchId, p1, p2, stake })
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus('createMatchStatus', 
                        `Match created successfully! TX: ${data.transactionHash}`, 
                        'success'
                    );
                } else {
                    showStatus('createMatchStatus', `Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus('createMatchStatus', `Network error: ${error.message}`, 'error');
            }
        }

        // Submit Result
        async function submitResult() {
            const matchId = document.getElementById('resultMatchId').value.trim();
            const winner = document.getElementById('winnerAddress').value.trim();

            if (!matchId || !winner) {
                showStatus('submitResultStatus', 'Please fill in all fields', 'error');
                return;
            }

            if (!validateAddress(winner)) {
                showStatus('submitResultStatus', 'Please enter a valid winner address', 'error');
                return;
            }

            clearStatus('submitResultStatus');
            showStatus('submitResultStatus', 'Submitting result...', 'info');

            try {
                const response = await fetch(`${BACKEND_BASE}/match/result`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ matchId, winner })
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus('submitResultStatus', 
                        `Result submitted successfully! TX: ${data.transactionHash}`, 
                        'success'
                    );
                } else {
                    showStatus('submitResultStatus', `Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus('submitResultStatus', `Network error: ${error.message}`, 'error');
            }
        }

        // Get Match Info
        async function getMatchInfo() {
            const matchId = document.getElementById('infoMatchId').value.trim();

            if (!matchId) {
                showStatus('matchInfoStatus', 'Please enter a match ID', 'error');
                return;
            }

            clearStatus('matchInfoStatus');
            showStatus('matchInfoStatus', 'Loading match info...', 'info');

            try {
                const response = await fetch(`${BACKEND_BASE}/match/${matchId}`);
                const data = await response.json();

                if (response.ok) {
                    const info = `
                        <strong>Match ID:</strong> ${data.matchId}<br>
                        <strong>Player 1:</strong> ${data.p1}<br>
                        <strong>Player 2:</strong> ${data.p2}<br>
                        <strong>Stake:</strong> ${data.stake} GT<br>
                        <strong>Status:</strong> ${data.status}<br>
                        <strong>P1 Staked:</strong> ${data.p1Staked ? 'Yes' : 'No'}<br>
                        <strong>P2 Staked:</strong> ${data.p2Staked ? 'Yes' : 'No'}<br>
                        <strong>Start Time:</strong> ${new Date(data.startTime * 1000).toLocaleString()}
                    `;
                    showStatus('matchInfoStatus', info, 'success');
                } else {
                    showStatus('matchInfoStatus', `Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus('matchInfoStatus', `Network error: ${error.message}`, 'error');
            }
        }

        // Refresh Leaderboard
        async function refreshLeaderboard() {
            const content = document.getElementById('leaderboardContent');
            content.innerHTML = '<div class="loading">Loading leaderboard...</div>';

            try {
                const response = await fetch(`${LEADERBOARD_BASE}/leaderboard`);
                const data = await response.json();

                if (response.ok && data.leaderboard && data.leaderboard.length > 0) {
                    let tableHTML = `
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Address</th>
                                    <th>Wins</th>
                                    <th>Total GT Won</th>
                                    <th>Matches Played</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.leaderboard.forEach((player, index) => {
                        tableHTML += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${player.address}</td>
                                <td>${player.wins}</td>
                                <td>${player.totalGTWon} GT</td>
                                <td>${player.matchesPlayed}</td>
                            </tr>
                        `;
                    });

                    tableHTML += '</tbody></table>';
                    content.innerHTML = tableHTML;
                } else {
                    content.innerHTML = '<div class="loading">No leaderboard data available</div>';
                }
            } catch (error) {
                content.innerHTML = `<div class="loading">Error loading leaderboard: ${error.message}</div>`;
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Check if API is running
            fetch(`${BACKEND_BASE}/health`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'OK') {
                        console.log('API is running');
                    }
                })
                .catch(error => {
                    console.log('API not running, please start the backend server');
                });
        });
    </script>
</body>
</html>
